/**
 * sainternet.xyz - resources/javascript/test.min.js
 * Copyright 2023 saint-lascivious (Hayden Pearce). All rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License
 */

/**
 * Announce ourselves.
 */
consoleWrapper('[Test] Loaded');

/**
 * Checks if an image exists at the specified URL.
 *
 * @function
 * @name testImage
 * @param {string} url - The URL of the image to check.
 * @return {Promise<boolean>} - A promise that resolves to true
 * if the image exists, false otherwise.
 */
function testImage(url) {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = () => resolve(true);
    img.onerror = () => resolve(false);
    img.src = url;
  });
}

/**
 * Replace one image with another.
 *
 * Displays the appropriate image based on the existence of an image at the
 * "failure.sainternet.xyz" domain and if it exists, it displays that image;
 * otherwise, it displays the image located at "success.sainternet.xyz".
 *
 * The expectation is that "failure.sainternet.xyz" will be available via
 * public DNS records, but shall be blocked via sainternet resolvers where
 * the record can be controlled locally.
 *
 * If neither can be located the result is unknown (the default).
 *
 * @function
 * @name displayTestResult
 */
async function displayTestResult() {
  try {
    const imageElement = document.getElementById('test-result-image');
    const failureExists = await testImage('https://failure.sainternet.xyz');
    if (failureExists) {
      consoleWrapper('[Test] Failed: failure.sainternet.xyz was resolved');
      imageElement.src = 'https://failure.sainternet.xyz';
    } else {
      const successExists = await testImage('https://success.sainternet.xyz');
      if (successExists) {
        consoleWrapper('[Test] Passed: success.sainternet.xyz was resolved');
        imageElement.src = 'https://success.sainternet.xyz';
      } else {
        consoleWrapper('[Test] Failed: success.sainternet.xyz not resolved');
        imageElement.src = 'resources/test/failure.webp';
      }
    }
  } catch (error) {
    consoleWrapper('[Test] Error', 'error');
  }
}

/**
 * Execute the aforementioned.
 */
window.onload = displayTestResult;
